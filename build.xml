<?xml version="1.0" encoding="UTF-8"?>

<!--
  Copyright 2011 Splunk, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"): you may
  not use this file except in compliance with the License. You may obtain
  a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations
  under the License.
-->

<!--
  UNDONE: Should build be a single file at root? or separate files for eg:
  splunk, examples and tests? or even more granular?

  UNDONE: How should manifest Class-Path be set for sample jars? They are 
  currently hardcoded to the corresponding relative repo paths, but that
  seems suspect.

  UNDONE: Example targets are hightly repetitive, seems like we should be
  able to do something better, eg: macroize?

  UNDONE: Should we factor properties into a separate build.properties file?

  UNDONE: Do we need debug & retail builds?

  UNDONE: Should we add "run" targets (for tests & examples) to the build file?
  instead of using the run script?
-->

<project name="splunk-sdk-java" basedir="." default="build">

    <property file="build.properties"/>

    <path id="classpath.splunk-sdk">
        <pathelement location="${lib.commons-cli}"/>
    </path>

    <path id="classpath.examples">
        <pathelement location="${dist.splunk}"/>
        <pathelement location="${dist.splunk-sdk}"/>
    </path>

    <!-- Classpaath for building tests -->
    <path id="classpath.tests">
        <pathelement location="${dist.splunk}"/>
        <pathelement location="${dist.splunk-sdk}"/>
        <pathelement location="${lib.junit}"/>
    </path>

    <!-- Classpath for executing test target -->
    <path id="classpath.test">
        <pathelement location="${lib.junit}"/>
        <pathelement location="${dir.build.tests}"/>
    </path>

    <target name="build" depends="dist"/>

    <target name="clean">
        <delete dir="${dir.build}"/>
        <delete dir="${dir.dist}"/>
    </target>

    <target name="compile-libs"
     depends="compile-splunk,compile-splunk-sdk"/>

    <target name="compile-splunk">
        <mkdir dir="${dir.build.splunk}"/>
        <javac includeantruntime="false"
         srcdir="${dir.splunk}"
         destdir="${dir.build.splunk}"/>
    </target>

    <target name="compile-splunk-sdk">
        <mkdir dir="${dir.build.splunk-sdk}"/>
        <javac includeantruntime="false"
         srcdir="${dir.splunk-sdk}"
         destdir="${dir.build.splunk-sdk}">
            <classpath refid="classpath.splunk-sdk"/>
        </javac>
    </target>

    <target name="compile-examples" 
     depends="compile-examples-spurl,compile-examples-test"/>

    <target name="compile-examples-spurl" depends="dist-libs">
        <mkdir dir="${dir.build.examples.spurl}"/>
        <javac includeantruntime="false"
         srcdir="${dir.examples.spurl}"
         destdir="${dir.build.examples.spurl}">
            <classpath refid="classpath.examples"/>
        </javac>
    </target>

    <target name="compile-examples-test" depends="dist-libs">
        <mkdir dir="${dir.build.examples.test}"/>
        <javac includeantruntime="false"
         srcdir="${dir.examples.test}"
         destdir="${dir.build.examples.test}">
            <classpath refid="classpath.examples"/>
        </javac>
    </target>

    <target name="compile-tests" depends="dist-libs">
        <mkdir dir="${dir.build.tests}"/>
        <javac includeantruntime="false"
         srcdir="${dir.tests}"
         destdir="${dir.build.tests}">
            <classpath refid="classpath.tests"/>
        </javac>
    </target>

    <target name="dist" 
     depends="dist-libs,dist-examples,dist-tests"/>

    <target name="dist-libs" 
     depends="dist-splunk,dist-splunk-sdk"/>

    <target name="dist-splunk" depends="compile-splunk">
        <mkdir dir="${dir.dist}"/>
        <jar 
         basedir="${dir.build.splunk}"
         destfile="${dist.splunk}"
         includes="**/*.class"/>
    </target>

    <target name="dist-splunk-sdk" depends="compile-splunk-sdk">
        <mkdir dir="${dir.dist}"/>
        <jar 
         basedir="${dir.build.splunk-sdk}"
         destfile="${dist.splunk-sdk}"
         includes="**/*.class">
            <manifest>
                <attribute name="Main-Class" value="Program"/>
                <attribute 
                 name="Class-Path" 
                 value="../lib/commons-cli-1.2.jar"/>
            </manifest>
        </jar>
    </target>

    <target name="dist-examples" depends="compile-examples">
        <mkdir dir="${dir.dist.examples}"/>

        <jar 
         basedir="${dir.build.examples.spurl}"
         destfile="${dir.dist.examples}/spurl.jar"
         includes="**/*.class">
            <manifest>
                <attribute name="Main-Class" value="Program"/>
                <attribute 
                 name="Class-Path" 
                 value="../splunk.jar ../splunk-sdk.jar"/>
            </manifest>
        </jar>

        <jar 
         basedir="${dir.build.examples.test}"
         destfile="${dir.dist.examples}/test.jar"
         includes="**/*.class">
            <manifest>
                <attribute name="Main-Class" value="Program"/>
                <attribute name="Class-Path" value="../splunk.jar"/>
            </manifest>
        </jar>
    </target>

    <target name="dist-tests" depends="compile-tests">
        <mkdir dir="${dir.dist}"/>
        <jar 
         basedir="${dir.build.tests}"
         destfile="${dist.tests}"
         includes="**/*.class">
            <manifest>
                <attribute name="Main-Class" value="Program"/>
                <attribute name="Class-Path" 
                 value="splunk.jar splunk-sdk.jar"/>
            </manifest>
        </jar>

    </target>

    <!-- Execute unit tests -->

    <!--
    <target name="test" depends="dist">
        <junit fork="yes" haltonfailure="no">
            <batchtest todir="${dir.dist}">
                <fileset dir="${dir.build.tests}" includes="**/*.class"/>
            </batchtest>
            <classpath refid="classpath.test"/>
            <formatter type="plain" usefile="false"/>
        </junit>
    </target>
    -->

    <target name="test" depends="dist">
        <junit fork="yes" haltonfailure="no">
            <batchtest>
                <zipfileset src="${dist.tests}">
                    <include name="**/*Test.class"/>
                </zipfileset>
            </batchtest>
            <classpath refid="classpath.test"/>
            <formatter type="plain" usefile="false"/>
        </junit>
    </target>
</project>
